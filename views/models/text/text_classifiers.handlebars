{{> header }}

<ul class="nav
          nav-tabs
          classifier__nav-tabs"
    id="classifier__tabs"
    role="tablist">

  <li class="nav-item classifier__nav-item">
    <a class="js--nav__tab--create nav-link classifier__nav-link active"
      data-toggle="tab"
      href="#home"
      role="tab"
      aria-controls="home"
      aria-selected="true">
        <h2>
          <i class="fas fa-plus"></i>
          Create 
          Model
        </h2>
    </a>
  </li>

  <li class="nav-item classifier__nav-item--or">
    <h2>
      &mdash; or  &mdash;
    </h2>
  </li>

  <li class="nav-item classifier__nav-item">
    <a class="js--nav__tab--explore nav-link classifier__nav-link"
      id=""
      data-toggle="tab"
      href="#explore"
      role="tab"
      aria-controls="profile"
      aria-selected="false">
        <h2>
          <i class="fas fa-eye"></i>
          Explore Your
          Models
        </h2>
    </a>
  </li>
</ul>

<div class="tab-content " id="myTabContent" class="classifier__tabs">
  <div class="js--classifier__tab--create tab-pane classifier__tab fade show active"
      role="tabpanel"
      aria-labelledby="home-tab">
    {{> text__create }}
  </div>

  <div class="js--classifier__tab--explore tab-pane classifier__tab fade"
        role="tabpanel"
        aria-labelledby="profile-tab"
        style="display: none !important">
    {{> text__explore }}
  </div>

</div>

{{> footer }}


<script>
    $(function() {

    /// set up info icon toggles
    $('.js--open-help').on('click', function(e){
        const section = $(e.target).closest('.step__body');
        $(section).find('.step__help').toggle();
        event.preventDefault(); // to keep from scrolling
    });

      /// set up video embeds
    const player = new Plyr('#js-classifier__video--clarifai');

    // set up page tabs
    // Doesnt work? https://getbootstrap.com/docs/4.0/components/navs/#javascript-behavior
    $('#classifier__tabs a').on('click', function (e) {
      e.preventDefault()
      // $(this).tab('show');
    })

    $('.js--nav__tab--create').on('click', function (e) {
        showCreateTab(true);
        showExploreTab(false);
    });

    $('.js--nav__tab--explore').on('click', function (e) {
        showCreateTab(false);
        showExploreTab(true);
    });

    // initialize the text classifier select area as a field for tags
    // using the Selectivize library
    $('.category__tag-select-container').selectize({
        delimiter: ',',
        persist: false,
        placeholder: 'write text things here!',
        create: function(input) {
            return {
                value: input,
                text: input
            }
        }
    });


    function showCreateTab(show) {
        const tabContent = $('.js--classifier__tab--create');
        if (show) {
            tabContent.addClass('show active');
            tabContent.show();
            tabContent.attr('style', '')
        } else {
            tabContent.removeClass('show active');
            tabContent.hide();
            tabContent.attr('style', 'display:none !important');
        }
    }

    function showExploreTab(show) {
        const tabContent = $('.js--classifier__tab--explore');
        if (show) {
            tabContent.addClass('show active');
            tabContent.show();
            tabContent.attr('style', '')
        } else {
            tabContent.removeClass('show active');
            tabContent.hide();
            tabContent.attr('style', 'display:none !important');
        }
    }
    });

    $(document).ready(function init() {

      window.training_data = {};

      $('form').submit(false);

      $('#input_projectName').on('input', function () {
        if ($(this).val().length > 0) {
          window.projectName = $(this).val();
        }
      });
        //read api key inputs
      $('.js--Rapikey__input').keypress((e) => {
          if (e.which == 13) {
              $('.js--Rapikey__input--set').trigger('click');
              e.preventDefault();
              return false;
          }
      });

      $('.js--explore__Rapikey__input').keypress((e) => {
          if (e.which == 13) {
              $('.js--explore__Rapikey__input--set').trigger('click');
              e.preventDefault();
              return false;
          }
      });

      $('.js--Rapikey__input--set').click(function () {
        if ($('.js--Rapikey__input').val() == '') {
          var n = makeNotification({
            message: 'Enter an API Key',
            type: 'warning',
            closeOlderInstances: true,
            stayOpenUntilClick: false
          });
          n.show();
          return;
        }
        window.RapiKey = $('.js--Rapikey__input').val();
        $('.js--explore__Rapikey__input').val(window.RapiKey);
      });

      $('.js--explore__Rapikey__input--set').click(function () {
        if ($('.js--explore__Rapikey__input').val() == '') {
          var n = makeNotification({
            message: 'Enter an API Key',
            type: 'warning',
            closeOlderInstances: true,
            stayOpenUntilClick: false
          });
          n.show();
          return;
        }
        window.RapiKey = $('.js--explore__Rapikey__input').val();
      });

    //write api key inputs
      $('.js--Wapikey__input').keypress((e) => {
          if (e.which == 13) {
              $('.js--Wapikey__input--set').trigger('click');
              e.preventDefault();
              return false;
          }
      });

      $('.js--explore__Wapikey__input').keypress((e) => {
          if (e.which == 13) {
              $('.js--explore__Wapikey__input--set').trigger('click');
              e.preventDefault();
              return false;
          }
      });

      $('.js--Wapikey__input--set').click(function () {
        if ($('.js--Wapikey__input').val() == '') {
          var n = makeNotification({
            message: 'Enter an API Key',
            type: 'warning',
            closeOlderInstances: true,
            stayOpenUntilClick: false
          });
          n.show();
          return;
        }
        window.WapiKey = $('.js--Wapikey__input').val();
        $('.js--explore__Wapikey__input').val(window.WapiKey);
      });

      $('.js--explore__Wapikey__input--set').click(function () {
        if ($('.js--explore__Wapikey__input').val() == '') {
          var n = makeNotification({
            message: 'Enter an API Key',
            type: 'warning',
            closeOlderInstances: true,
            stayOpenUntilClick: false
          });
          n.show();
          return;
        }
        window.WapiKey = $('.js--explore__Wapikey__input').val();
      });

    //set username stuff
      $('.js--username__input').keypress((e) => {
          if (e.which == 13) {
              $('.js--username__input--set').trigger('click');
              e.preventDefault();
              return false;
          }
      });

      $('.js--explore__username__input').keypress((e) => {
          if (e.which == 13) {
              $('.js--explore__username__input--set').trigger('click');
              e.preventDefault();
              return false;
          }
      });

      $('.js--username__input--set').click(function () {
        if ($('.js--username__input').val() == '') {
          var n = makeNotification({
            message: 'Enter a Username',
            type: 'warning',
            closeOlderInstances: true,
            stayOpenUntilClick: false
          });
          n.show();
          return;
        }
        window.username = $('.js--username__input').val();
        $('.js--explore__username__input').val(window.username);
      });

      $('.js--explore__username__input--set').click(function () {
        if ($('.js--explore__username__input').val() == '') {
          var n = makeNotification({
            message: 'Enter a Username',
            type: 'warning',
            closeOlderInstances: true,
            stayOpenUntilClick: false
          });
          n.show();
          return;
        }
        window.username = $('.js--explore__username__input').val();
      });


    //category name stuff
      $('#input_categoryName').keypress((e) => {
          if (e.which == 13) {
              $('#button_categoryName').trigger('click');
              e.preventDefault();
              return false;
          }
      });

      $('#button_categoryName').click(function () {
        if ($('#input_categoryName').val() == '') {
          var n = makeNotification({
            message: 'Enter a category to train.',
            type: 'warning',
            closeOlderInstances: true,
            stayOpenUntilClick: false
          });
          n.show();
          return;
        }

        // TODO: Sanitize categoryName before further processing
        var categoryName = $('#input_categoryName').val();
        if (window.training_data.hasOwnProperty(categoryName)) {
          var n = makeNotification({
            message: 'Enter a different category name, this one already exists',
            type: 'warning',
            closeOlderInstances: true,
            stayOpenUntilClick: false
          });
          n.show();
          return;
        }
        window.training_data[categoryName] = [];
        console.log(window.training_data);
        {{!-- createCategoryHTMLElement(categoryName); --}}
        $('#input_categoryName').val('');
      });

      $('.js--train__button').on('click', function () {
          setTrainButtonState('training');
          preprocessTrainData();
      })

      $('.js--classifier__predict__button').on('click', function () {
          preprocessPredictData();
      })
    });

    function selectClassifier(model_id) {
        window.model_id = model_id;
        return false;
    };

    async function setUserClassifiers() {
        var userClassifiers = await loadUserClassifiers();
        addClassifiersToDropdown(userClassifiers);
    }

    function addClassifiersToDropdown(classifiers) {
        const dropdownElement = $('.js--classifiers__dropdown');
        dropdownElement.html('');
        classifiers.forEach((classifier) => {
            const dropdownItemStructure = `<a class="js--classifiers__dropdown__item dropdown-item" onclick="selectClassifier('${classifier.classifier_id}');">${classifier.name}</a>`;
            const dropdownItem = $(dropdownItemStructure);
            dropdownElement.append(dropdownItem);
        });
    }

    function loadUserClassifiers() {
      $.ajax({
           url: "/vision/classifiers",
           type: "GET",
           headers: { 'apiKey': window.apiKey },
           success: function (data) {
             if(data.error == null) {
               window.userClassifiers = data.classifiers;
             } else {
               window.userClassifiers = [];
             }
             displayClassifiers();
           },
           error: function (data) {
             console.log(data);
             window.userClassifiers = [];
           }
        });
    }

    function createCategoryHTMLElement(categoryName) {
        const htmlStructure = `<div class="category__container
                                           js--dropzone__category__container--${categoryName}">
            <div class="category__box">
                <form action="/"
                       class="dropzone--categories
                              js--dropzone__category--${categoryName}">
                  <div class="category__name">
                        ${categoryName}
                    </div>

                    <div class="dropzone__header">
                        <i class="fas fa-cloud-upload-alt
                                    dropzone__upload-icon"></i>
                        <span class="dropzone__label">Drag and drop 10 or more images</span>
                    </div>

                    <!-- inject image previews here -->
                    <div class="js--dropzone__previews-container dropzone-previews"
                         id="js--dropzone__previews-container_${categoryName}">
                    </div>

                    <div class="dropzone__error-container"></div>
                </form>
            </div>

            <a href="#" class="category__button--remove
                               btn btn-primary
                               js--dropzone__category__remove--${categoryName}">
                <i class="fas fa-times"></i>
            </a>
        </div>`;
        const htmlElement = $(htmlStructure);
        const categoriesContainerElement = $('#categoriesContainer');
        categoriesContainerElement.append(htmlElement);
        initDropZoneForClass(categoryName);
    }

    function initDropZoneForClass(categoryName) {
      const dropzoneFormClass = `.js--dropzone__category--${categoryName}`;
      const dropzonePreviewsContainerClass = `.js--dropzone__previews__container--${categoryName}`;
      const dropzoneRemoveClass = `.js--dropzone__category__remove--${categoryName}`;
      const dropzoneCategoryInstance = new Dropzone(dropzoneFormClass, {
          url: "/file/post" ,
          paramName: "category-image",
          maxFilesize: 5, //  MB
          maxFiles: 20,
          autoProcessQueue: false,
          dictRemoveFile: "",
          acceptedFiles: ".jpg,.jpeg,.png",
          addRemoveLinks: true, //  enable person to del file
          thumbnailWidth: 80,
          thumbnailHeight: 80,
          previewsContainer: document.querySelector(dropzonePreviewsContainerClass),
          init: function () {
            this.on("error", function(file) {
              if (!file.accepted) {
                this.removeFile(file);
              }
            });
          }
      });
      $(dropzoneRemoveClass).click((e) => {
          e.preventDefault();
          removeDropZoneByClass(categoryName);
      });
      window.dropZoneMap[categoryName] = dropzoneCategoryInstance;
    }

    function removeDropZoneByClass(categoryName) {
        if (window.labels == undefined || !window.labels.includes(categoryName)) {
            return;
        }
        const dropZoneCategoryClass = `.js--dropzone__category__container--${categoryName}`;
        const dropzoneFormClass = `.js--dropzone__category--${categoryName}`;
        const dropzonePreviewsContainerClass = `.js--dropzone__previews__container--${categoryName}`;
        const dropzoneRemoveClass = `.js--dropzone__category__remove--${categoryName}`;
        window.dropZoneMap[categoryName].disable();
        delete window.dropZoneMap[categoryName];
        $(dropzoneRemoveClass).unbind();
        $(dropZoneCategoryClass).remove();
        delete window.labels[categoryName];
        if (window.examples != undefined && window.examples[categoryName] != undefined) {
            delete window.examples[categoryName];
        }
    }

    function setTrainButtonState(state) {
        if (state == 'normal') {
            $('.js--train__button').removeAttr('disabled');
            $('#span_train').removeClass('spinner-grow spinner-grow-sm');
            $('#span_train_status').html('Train Model');
        } else if (state == 'training') {
            $('.js--train__button').attr('disabled', '');
            $('#span_train').addClass('spinner-grow spinner-grow-sm');
            $('#span_train_status').html('Training Model');
        } else if (state == 'finished') {
            $('.js--train__button').removeAttr('disabled');
            $('#span_train').removeClass('spinner-grow spinner-grow-sm');
            $('#span_train_status').html('Done');
            $('.js--train__button').unbind();
        }
    }

    async function preprocessTrainData() {
        setTrainButtonState('training');
        try {
            validateTrainingData();
            var userClassifiers = await loadUserClassifiers();
            if (projectNameAlreadyUsed(userClassifiers)) {
              var n = makeNotification({
                message: 'A project with this name already exists. Create one with a different name.',
                type: 'warning',
                closeOlderInstances: true,
                stayOpenUntilClick: true
              });
              n.show();
              throw new Error('A project with this name already exists. Create one with a different name.');
              return;
            }
            await convertImagesIntoExamples();
            await createClassifier();
            setTrainButtonState('finished');
            setClassifierStatus();
            setAutoRefreshStatus(true);
        } catch (error) {
            console.log(error);
            setTrainButtonState('normal');
        }
    }

    function validateTrainingData() {
        // if (window.projectName === undefined || window.projectName.length < 2) {
        //     throw new Error("Project name is too short or empty");
        // }
        // if (window.apiKey === undefined || window.apiKey.length < 1) {
        //     throw new Error("API key not set");
        // }
        if (window.labels === undefined || window.labels.length < 2) {
            var n = makeNotification({
              message: 'Create at least 2 classes.',
              type: 'warning',
              closeOlderInstances: true,
              stayOpenUntilClick: true
            });
            n.show();

            throw new Error("Create at least 2 classes.");
        }
        for (const className of Object.keys(window.dropZoneMap)) {
            if (window.dropZoneMap[className].files === undefined || window.dropZoneMap[className].files.length < 10) {
              var n = makeNotification({
                message: `${className} category needs at least 10 examples.`,
                type: 'warning',
                closeOlderInstances: true,
                stayOpenUntilClick: true
              });
              n.show();
              throw new Error(`${className} category has less than 10 examples`);
            }
        }
    }

    function loadUserClassifiers() {
        return new Promise((resolve, reject) => {
            $.ajax({
                 url: "/vision/classifiers",
                 type: "GET",
                 headers: { 'apiKey': window.apiKey },
                 success: function (data) {
                     if(data.error == null) {
                         resolve(data.classifiers);
                         return;
                     }
                     reject(new Error(data.error));
                 },
                 error: function (error) {
                     reject(error);
                 }
            });
        });
    }

    function projectNameAlreadyUsed(classifiers) {
        if (classifiers == undefined || classifiers.length == 0) return false;
        for (var index = 0; index < classifiers.length; index++) {
            var classifier = classifiers[index];
            if (classifier.name == window.projectName) return true;
        }
        return false;
    }

    async function convertImagesIntoExamples() {
        if(window.dropZoneMap.length < 1) {
            throw new Error("Create at least 2 classes.");
        }
        for (const className of Object.keys(window.dropZoneMap)) {
            var promises = [];
            Array.from(window.dropZoneMap[className].files).forEach((file) => {
                if(file == undefined) return;
                var promise = new Promise((resolve, reject) => {
                    var reader = new FileReader();
                    reader.onloadend = function() {
                        resolve(reader.result);
                    }
                    reader.readAsDataURL(file);
                });
                promises.push(promise);
            });
            base64Images = await Promise.all(promises);
            try {
                setBase64Examples(className, base64Images);
            } catch (e) {
                throw e;
            }
        }
    }

    function setBase64Examples(className, examples) {
        if (window.examples == undefined) {
            window.examples = {};
        }
        window.examples[className] = examples;
    }

    function createClassifier() {
        var requestData = {};
        requestData.name = window.projectName;
        requestData.training_data = [];
        window.labels.forEach((label) => {
            label_items = [];
            window.examples[label].forEach((example) => {
                var image_file = example.split(',')[1];
                label_items.push(image_file);
            });
            requestData.training_data.push({label: label, label_items: label_items});
        })
        return new Promise((resolve, reject) => {
            $.ajax({
                url: '/vision/classifier',
                type: 'POST',
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(requestData),
                headers: { apikey: window.apiKey },
                success: function (data) {
                    if(data.error != null) {
                        var n = makeNotification({
                          message: 'We couldn\'t save to Clarifai :( Some technical info: ' + data.error,
                          type: 'error',
                          closeOlderInstances: true,
                          stayOpenUntilClick: false
                        });
                        n.show();
                        reject(new Error(data.error));
                        return;
                    }
                    window.model_id = data.classifier_id;
                    window.classifier_status = data.status;
                    resolve();
                },
                error: function (error) {
                    reject(error);
                }
            });
        });
    }

    function setClassifierStatus() {
        const classifierNameClass = ".js--classifier__name";
        const classifierStatusClass = ".js--classifier__status";
        const classifierRefreshSpinnerClass = ".js--classifier__status_spinner";
        $(`${classifierNameClass}--set`).html(window.model_id);
        $(`${classifierStatusClass}--set`).html(window.classifier_status);
        $(classifierNameClass).show();
        $(classifierStatusClass).show();
        if (window.classifier_status.includes('successfully')) {
            $(classifierRefreshSpinnerClass).hide();
            setAutoRefreshStatus(false);
        } else {
            $(classifierRefreshSpinnerClass).show();
        }
    }

    function setAutoRefreshStatus(autoRefresh) {
        if (!autoRefresh) {
            if (window.autoRefreshTimer != undefined) {
                clearInterval(window.autoRefreshTimer);
                window.autoRefreshTimer = undefined;
            }
        } else {
            window.autoRefreshTimer = setInterval(() => {
                loadUserClassifier(window.model_id);
            }, 2000);
        }
    }

    function loadUserClassifier(classifier_id) {
        $.ajax({
             url: "/vision/classifier",
             type: "GET",
             headers: { 'apikey': window.apiKey },
             data: { classifier_id: classifier_id},
             success: function (data) {
                 if(data.error == null) {
                      window.classifier_status = data.status;
                 } else {
                      var n = makeNotification({
                        message: 'We couldn\'t get the API key you entered :( Some more technical info: ' + data.error,
                        type: 'error',
                        closeOlderInstances: true,
                        stayOpenUntilClick: true
                      });
                      n.show();
                 }
                 setClassifierStatus();
             },
             error: function (error) {
                 console.log(error);
             }
          });
    }

    async function preprocessPredictData() {
        try {
            validatePredictionData();
            await loadPredictionImage();
            classify();
        } catch (error) {
            var n = makeNotification({
              message: error,
              type: 'error',
              closeOlderInstances: true,
              stayOpenUntilClick: true
            });
            n.show();
            console.log(error);
        }
    }

    function validatePredictionData() {
        if (window.dropzonePredict.files === undefined || window.dropzonePredict.files.length != 1) {
              var n = makeNotification({
              message: 'Add an image to predict.',
              type: 'warning',
              closeOlderInstances: true,
              stayOpenUntilClick: true
            });
            n.show();
            throw new Error('Add an image to predict.');
        }
    }

    function loadPredictionImage() {
        var promise = new Promise((resolve, reject) => {
            var reader = new FileReader();
            reader.onloadend = function() {
                window.predictionImage = reader.result;
                resolve(reader.result);
            }
            reader.readAsDataURL(window.dropzonePredict.files[0]);
        });
        return promise;
    }

    function classify() {
        if(window.predictionImage == undefined) {
            var n = makeNotification({
              message: 'Set prediction to run the model.',
              type: 'warning',
              closeOlderInstances: true,
              stayOpenUntilClick: false
            });
            n.show();
          return;
        }
        $.ajax({
             url: "/vision/classify",
             type: "POST",
             headers: { 'apikey': window.apiKey },
             data: { classifier_id: window.model_id,
             image_data: window.predictionImage },
             success: function (data) {
                 if(data.error == null) {
                    showClassification(data);
                 } else {
                    var n = makeNotification({
                      message: 'We couldn\'t save the API key you entered :( Some more technical info: ' + data.error,
                      type: 'error',
                      closeOlderInstances: true,
                      stayOpenUntilClick: true
                    });
                    n.show();
                 }
             },
             error: function (error) {
                console.log(error);
                var n = makeNotification({
                  message: 'We couldn\'t save the API key you entered :( Some more technical info: ' + error,
                  type: 'error',
                  closeOlderInstances: true,
                  stayOpenUntilClick: true
                });
                n.show();
             }
        });
        window.dropzonePredict.removeAllFiles();
    }

    function showClassification(response) {
        if(response.length == 1) {
            var n = makeNotification({
              message: `The model says ${response[0].class}! with a confidence score of ${response[0].score}.`,
              type: 'success',
              closeOlderInstances: true,
              stayOpenUntilClick: true
            });
        } else {
            var classes = {}
            var scores = []
            for(var idx = 0; idx < response.length; idx++) {
                let score = response[idx].score
                let className = response[idx].class
                classes[score] = className
                scores.push(score)
            }
            scores.sort(function(a, b) {
                return b - a;
            })
            let score = scores[0]
            let className = classes[score]
            var n = makeNotification({
              message: `The model says ${className}! with a confidence score of ${score}.`,
              type: 'success',
              closeOlderInstances: true,
              stayOpenUntilClick: true
            });
        }
    }

</script>